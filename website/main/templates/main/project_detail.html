{% extends 'main/base.html' %}

{% block content %}
<div class="container">
    <h1>{{ project.title }}</h1>
    <p>{{ project.description }}</p>
    {% if project.image %}
        <img src="{{ project.image.url }}" alt="{{ project.title }}" width="300px">
    {% endif %}
    <p>Owner: {{ project.owner.username }}</p>
    <p>Tags: {{ project.tags }}</p>
    {% if project.demo_link %}
        <p>Demo: <a href="{{ project.demo_link }}">{{ project.demo_link }}</a></p>
    {% endif %}
    {% if project.source_code_link %}
        <p>Source Code: <a href="{{ project.source_code_link }}">{{ project.source_code_link }}</a></p>
    {% endif %}

    <div id="like-section">
        <button id="like-button" class="btn btn-primary {% if request.user in project.likes.all %}active{% endif %}" data-project-id="{{ project.id }}">
            {% if request.user in project.likes.all %}Unlike{% else %}Like{% endif %} (<span id="likes-count">{{ project.total_likes }}</span>)
        </button>
    </div>

    <div id="rating-container">
        Rating: <span id="average-rating">{{ project.average_rating }}</span> / 7
        {% if user.is_authenticated %}
            <div>
                {% for i in "1234567" %}
                    <button class="rate-button" data-rating="{{ i }}">{{ i }}</button>
                {% endfor %}
            </div>
        {% endif %}
    </div>

    <div>
        <h2>Comments</h2>
        {% for comment in project.comments.all %}
            <p>{{ comment.user.username }}: {{ comment.text }}</p>
        {% empty %}
            <p>No comments yet.</p>
        {% endfor %}

        {% if user.is_authenticated %}
            <form method="post">
                {% csrf_token %}
                {{ comment_form.as_p }}
                <button type="submit" name="comment_submit">Add Comment</button>
            </form>
        {% endif %}
    </div>

    <div>
        <h2>Reactions</h2>
        {% if user.is_authenticated %}
            <button class="react-button" data-reaction="like"><i class="far fa-thumbs-up"></i></button>
            <button class="react-button" data-reaction="love"><i class="fas fa-heart"></i></button>
            <button class="react-button" data-reaction="wow"><i class="fas fa-star"></i></button>
            <button class="react-button" data-reaction="haha"><i class="far fa-laugh"></i></button>
            <button class="react-button" data-reaction="sad"><i class="far fa-frown"></i></button>
            <button class="react-button" data-reaction="angry"><i class="fas fa-angry"></i></button>
        {% endif %}
    </div>

    {% if user.is_authenticated and user != project.owner %}
        {% if not has_sent_request %}
            <form method="post" action="{% url 'send_collaboration_request' project.id %}">
                {% csrf_token %}
                <button type="submit">Request Collaboration</button>
            </form>
        {% else %}
            <p>Collaboration request sent.</p>
        {% endif %}
    {% endif %}

    {% if request.user == project.owner %}
        <a href="{% url 'edit_project' project.id %}">Edit</a>
        <a href="{% url 'delete_project' project.id %}">Delete</a>
    {% endif %}
</div>
<script>
    const likeButton = document.getElementById('like-button');
    likeButton.addEventListener('click', () => {
        const projectId = likeButton.dataset.projectId;
        fetch(`/project/${projectId}/like/`, {
            method: 'POST',
            headers: {